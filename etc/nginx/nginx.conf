# Nginx configuration file by Carl Bennett <https://carlbennett.me>
# For more information on configuration, see:
#   * Official English Documentation: http://nginx.org/en/docs/
#   * Official Russian Documentation: http://nginx.org/ru/docs/

# Nginx will fail to start if /run/nginx.pid already exists but has the wrong
# SELinux context. This might happen when running `nginx -t` from the cmdline.
# https://bugzilla.redhat.com/show_bug.cgi?id=1268621
error_log /var/log/nginx/error.log;
pid       /run/nginx.pid;

user nginx nginx; # user=nginx group=nginx

worker_processes auto;

# Load dynamic modules. See /usr/share/nginx/README.dynamic.
include /usr/share/nginx/modules/*.conf;

pcre_jit on;

events {
  worker_connections 1024;
  multi_accept       on;
}

# Uncomment this block on nginx versions older than 1.9.0
#mail {
#  # Enable or disable mail proxy
#  #
#  proxy  off;
#}

http {
  log_format vhost_combined '$http_host $remote_addr - $remote_user '
                            '[$time_local] "$request" $status '
                            '$body_bytes_sent "$http_referer" '
                            '"$http_user_agent"';

  # This format shouldn't be used if `conf.d/real-ip-resolution.conf` is
  # included further below, since `$remote_addr` will populate with the
  # correct IP address.
  log_format vhost_proxy_combined '$http_host $http_x_forwarded_for - '
                                  '$remote_user [$time_local] "$request" '
                                  '$status $body_bytes_sent '
                                  '"$http_referer" "$http_user_agent"';

  access_log /var/log/nginx/access.log vhost_combined;

  sendfile    on;
  tcp_nodelay on;
  tcp_nopush  on;

  client_body_timeout       10;
  client_max_body_size      1G;
  keepalive_timeout         65;
  reset_timedout_connection on;

  server_names_hash_bucket_size 64;
  server_names_hash_max_size 1024;
  types_hash_bucket_size 256;
  types_hash_max_size 2048;

  include /etc/nginx/mime.types;
  # Specifies the MIME-type to use if it cannot be determined. It's safe to
  # set this to 'application/octet-steam' to prevent web browsers from
  # displaying an unknown file (possibly not even text) to the user. You can
  # change this to the 'text/*' context to have unknown files display in the
  # browser, such as 'text/plain':
  default_type application/octet-stream;

  # Do not advertise the nginx version number in responses:
  server_tokens off;

  # Load other index files in specified order. Default is only index.html:
  # https://nginx.org/en/docs/http/ngx_http_index_module.html
  index index.xml index.html index.htm;

  autoindex            off;
  autoindex_exact_size off;
  autoindex_localtime  on;

  ssl_prefer_server_ciphers on;
  # On nginx < 1.13.0, remove 'TLSv1.3' below:
  ssl_protocols             TLSv1.3 TLSv1.2;
  ssl_ciphers               'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:!CBC:!DSS:!aNULL';
  ssl_session_cache         shared:SSL:10m;
  ssl_session_tickets       off;
  ssl_session_timeout       10m;
  ssl_trusted_certificate   /etc/pki/tls/certs/ca-bundle.trust.crt;

  http2  on;
  http3  on; # aka QUIC (HTTPS over UDP) useful for streams

  # Load Diffie-Hellman Parameters
  include /etc/nginx/conf.d/dhparams.conf;

  # Load expires map.
  include /etc/nginx/conf.d/expires.map.conf;

  # Load real IP resolution map.
  # The fixes `$remote_addr` when behind services like Amazon AWS or Cloudflare.
  include /etc/nginx/conf.d/real-ip-resolution.conf;

  # Load error code map.
  include /etc/nginx/conf.d/error-code-map.conf;

  # Load virtual hosts.
  include /etc/nginx/vhost.d/*.conf;
}
